<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance System</title>
    <link rel="stylesheet" href="new_style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Symbol styling */
        .status-symbol {
            font-weight: bold;
            margin-left: 8px;
        }
        option.done::after {
            content: " ‚úÖ";
        }
        option.active::after {
            content: " ‚è≥";
        }
        option.expired::after {
            content: " ‚ùå";
        }
        .disabled-input {
            background-color: #eee;
            pointer-events: none;
        }

        /* ==== ALTERED START: message modal basic styles (reuse your modal classes) ==== */
        .modal {
            display: none; /* default hidden */
            position: fixed;
            z-index: 10000;
            inset: 0;
            background: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            max-width: 520px;
            width: 100%;
            padding: 20px 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .modal-content h3 {
            margin: 0 0 8px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
        }
        .btn {
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-primary { background: #2e6bff; color: #fff; }
        .btn-plain { background: #eee; color: #222; }
   
 /* Loader overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9); /* semi-transparent background */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;

    opacity: 0;
    visibility: hidden;
    transition: opacity 0.5s ease, visibility 0.5s ease;
    z-index: 9999;
}

/* When active (JS will add this class) */
.loading-overlay.active {
    opacity: 1;
    visibility: visible;
}

/* Rotating logo */
.loader-img {
    width: 70px;
    height: 70px;
    animation: spin 2s linear infinite;
    margin-bottom: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Text pulse */
#loading p {
    animation: pulse 1.5s infinite;
    font-weight: bold;
    color: #2e6bff;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}


    </style>
</head>
<body>

<script>
// Disable right-click
document.addEventListener("contextmenu", e => e.preventDefault());

// Disable common DevTools shortcuts
document.onkeydown = e => {
    if (
        e.keyCode === 123 || // F12
        (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || // Ctrl+Shift+I/J/C
        (e.ctrlKey && e.keyCode === 85) // Ctrl+U (View Source)
    ) {
        e.preventDefault();
        return false;
    }
};

// Detect if DevTools is open
(function() {
    let devtools = function() {};
    devtools.toString = function() {
        alert("‚ö† Developer tools are disabled on this system.");
        return "";
    };
    console.log("%c", devtools);
})();
</script>

<!-- Modal -->
<div id="instructionModal" class="modal">
    <div class="modal-content">
        <h2>üìå Instructions</h2>
        <p>Welcome to the <strong>Student Attendance System</strong>. Please follow these steps carefully:</p>
        <ol>
            <li><strong>Enter your details:</strong> Provide your <em>Student Number</em>, <em>First Name</em>, and <em>Last Name</em> correctly.</li>
            <li><strong>Select your course:</strong> Choose your <em>Course</em> from the dropdown menu.</li>
            <li><strong>Pick your login time:</strong> Select the <em>designated time slot</em> for attendance.</li>
            <li><strong>Enable location services:</strong> Ensure your <em>GPS is turned on</em> for verification.</li>
            <li><strong>Click "Login":</strong> Press the <em>Login</em> button to submit your attendance.</li>
        </ol>
        <p><strong>‚ö† Important:</strong> You can only log in during the allowed time slots. Multiple logins may be restricted.</p>
        <button id="closeModal" class="btn btn-primary">Got It!</button>
    </div>
</div>

<!-- ==== ALTERED START: message modal container ==== -->
<div id="messageModal" class="modal">
    <div class="modal-content">
        <h3 id="messageTitle">Notice</h3>
        <div id="messageBody">...</div>
        <div class="modal-actions">
            <button id="messageClose" class="btn btn-primary">OK</button>
        </div>
    </div>
</div>
<!-- ==== ALTERED END ==== -->

<div class="logo">
    <img src="LOGO.jpg" alt="Logo">
    <div class="department">ECT DEPARTMENT</div>
</div>
<div class="container">
    <h2>Student Attendance System</h2>

    <input type="text" id="studentNumber" placeholder="Student Number" required>
    <input type="text" id="lastName" placeholder="Last Name" required>
    <input type="text" id="firstName" placeholder="First Name" required>

    <select id="course" required>
        <option value="">Select Course</option>
        <option value="CE1A">CE1A</option>
        <option value="CE1B">CE1B</option>
        <option value="CE2A">CE2A</option>
        <option value="CE3A">CE3A</option>
        <option value="CE4A">CE4A</option>
        <option value="CS1A">CS1A</option>
        <option value="CS2A">CS2A</option>
        <option value="CS3A">CS3A</option>
        <option value="CS4A">CS4A</option>
        <option value="IT1A">IT1A</option>
        <option value="IT1B">IT1B</option>
        <option value="IT1C">IT1C</option>
        <option value="IT1D">IT1D</option>
        <option value="IT2A">IT2A</option>
        <option value="IT2B">IT2B</option>
        <option value="IT2C">IT2C</option>
        <option value="IT3A">IT3A</option>
        <option value="IT4A">IT4A</option>
        <option value="EN1A">EN1A</option>
        <option value="EN1B">EN1B</option>
        <option value="EN2A">EN2A</option>
        <option value="EN2B">EN2B</option>
        <option value="EN3A">EN3A</option>
        <option value="EN4A">EN4A</option>
        <option value="IRREG-BSIT">IRREG-BSIT</option>
        <option value="IRREG-BSCS">IRREG-BSCS</option>
        <option value="IRREG-BSELE">IRREG-BSELE</option>
        <option value="IRREG-BSCOE">IRREG-BSCOE</option>
    </select>

    <select id="loginTime" required>
        <option value="">Select Login Time</option>
    </select>

    <input type="hidden" id="barangay" name="barangay">
    <input type="hidden" id="city" name="city">

    <button id="loginBtn">Login</button>
</div>

<div id="loading" class="loading-overlay">
    <img src="loading.png" alt="Loading..." class="loader-img">
    <p>Processing...</p>
</div>



<footer class="footer">
    Powered by: <span class="faculty-name">VBadua ECT FACULTY</span>
</footer>

<script type="module" src="firebase.js"></script>
<script type="module">
import { 
    db, collection, addDoc, serverTimestamp, query, where, getDocs, doc, getDoc 
} from "./firebase.js";

// Loading indicators
function showLoading() { $("#loading").show(); }
function hideLoading() { $("#loading").hide(); }

// Generate or get persistent device ID
function getDeviceID() {
    let deviceID = localStorage.getItem("deviceID");
    if (!deviceID) {
        deviceID = crypto.randomUUID ? crypto.randomUUID() : "device-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("deviceID", deviceID);
    }
    return deviceID;
}


function showLoader() {
    document.getElementById("loading").classList.add("active");
}

function hideLoader() {
    document.getElementById("loading").classList.remove("active");
}


// ==== ALTERED START: date helpers & constants (lock feature) ====
const LOCK_MINUTES = 30;
const LOCK_KEY = "attendanceLockUntil";

function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
}

function getLockUntil() {
    const v = parseInt(localStorage.getItem(LOCK_KEY) || "0", 10);
    return Number.isFinite(v) ? v : 0;
}
function setLock(minutes = LOCK_MINUTES) {
    const until = Date.now() + minutes * 60 * 1000;
    localStorage.setItem(LOCK_KEY, String(until));
    return until;
}
function clearLock() {
    localStorage.removeItem(LOCK_KEY);
}
// ==== ALTERED END ====

// ==== ALTERED START: message modal utilities ====
function showMessageModal(title, htmlMessage) {
    $("#messageTitle").text(title || "Notice");
    $("#messageBody").html(htmlMessage || "");
    const $m = $("#messageModal");
    $m.css("display","flex");
    return new Promise(resolve => {
        const close = () => { 
            $m.hide(); 
            $("#messageClose").off("click", close);
            $m.off("click", overlayClose);
            resolve();
        };
        const overlayClose = (e) => { if (e.target.id === "messageModal") close(); }
        $("#messageClose").on("click", close);
        $m.on("click", overlayClose);
    });
}
// ==== ALTERED END ====

// ==== ALTERED START: UI lock & countdown handling ====
let lockTimer = null;

function setInputsDisabled(disabled) {
    $("#studentNumber, #lastName, #firstName, #course, #loginTime, #loginBtn")
        .prop("disabled", disabled)
        .toggleClass("disabled-input", disabled);
}

function applyLockUI(lockUntil) {
    if (lockTimer) { clearInterval(lockTimer); lockTimer = null; }
    const $btn = $("#loginBtn");
    const update = () => {
        const now = Date.now();
        if (now >= lockUntil) {
            clearInterval(lockTimer);
            lockTimer = null;
            setInputsDisabled(false);
            $btn.text("Login");
            clearLock();
            return;
        }
        setInputsDisabled(true);
        const remaining = Math.max(0, Math.floor((lockUntil - now)/1000));
        const mm = String(Math.floor(remaining/60)).padStart(2,"0");
        const ss = String(remaining%60).padStart(2,"0");
        $btn.text(`Locked ${mm}:${ss}`);
    };
    update();
    lockTimer = setInterval(update, 1000);
}
// ==== ALTERED END ====

// Load login times into dropdown
async function loadLoginTimes() {
    const dropdown = $("#loginTime");
    dropdown.empty().append(`<option value="">Select Login Time</option>`);
    try {
        const settingsDocRef = doc(db, "settings", "attendanceWindows");
        const snapshot = await getDoc(settingsDocRef);
        if (snapshot.exists()) {
            const data = snapshot.data();
            if (Array.isArray(data.slots)) {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();

                data.slots.forEach(slot => {
                    if (slot.start && slot.end && slot.title) {
                        const label = `${slot.title} (${slot.start} - ${slot.end})`;
                        const [sh, sm] = slot.start.split(":").map(Number);
                        const [eh, em] = slot.end.split(":").map(Number);
                        const startM = sh * 60 + sm;
                        const endM = eh * 60 + em;

                        let statusClass = "expired";
                        if (currentMinutes >= startM && currentMinutes <= endM) {
                            statusClass = "active";
                        } else if (currentMinutes < startM) {
                            statusClass = "";
                        }

                        dropdown.append(`<option value="${slot.start}" class="${statusClass}">${label}</option>`);
                    }
                });
            }
        } else {
            console.warn("‚ö† No attendance windows found in Firestore.");
        }
    } catch (error) {
        console.error("Error loading login times:", error);
    }
}

// Check if current time is within allowed slot
async function isWithinAllowedTime(selectedTime) {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const normalizedSelected = selectedTime.trim().padStart(5, "0");

    try {
        const settingsDocRef = doc(db, "settings", "attendanceWindows");
        const snapshot = await getDoc(settingsDocRef);
        if (snapshot.exists()) {
            const data = snapshot.data();
            if (Array.isArray(data.slots)) {
                for (const slot of data.slots) {
                    if (slot.start && slot.end) {
                        const start = slot.start.trim().padStart(5, "0");
                        const end = slot.end.trim().padStart(5, "0");
                        if (start === normalizedSelected) {
                            const [startHour, startMinute] = start.split(":").map(Number);
                            const [endHour, endMinute] = end.split(":").map(Number);
                            const startMinutes = startHour * 60 + startMinute;
                            const endMinutes = endHour * 60 + endMinute;
                            if (currentMinutes >= startMinutes && currentMinutes <= endMinutes) return true;
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error checking time slot:", error);
    }
    return false;
}

// ==== ALTERED START: include date in duplicate and device bindings ====
// Check if student already logged in for this time TODAY
async function checkDuplicateLogin(studentNumber, selectedTime, attendanceDate) {
    const qy = query(
        collection(db, "student_attendance"),
        where("studentNumber", "==", studentNumber),
        where("selectedTime", "==", selectedTime),
        where("attendanceDate", "==", attendanceDate)
    );
    const snapshot = await getDocs(qy);
    return !snapshot.empty;
}

// Enforce one-user-per-device (bind device to first user who used it)
async function checkDeviceBinding(studentNumber, deviceID) {
    const qy = query(
        collection(db, "student_attendance"),
        where("deviceID", "==", deviceID)
    );
    const snapshot = await getDocs(qy);
    // If device has previous records and any belong to another student, block
    for (const d of snapshot.docs) {
        const rec = d.data();
        if (rec.studentNumber && rec.studentNumber !== studentNumber) {
            return { ok:false, boundTo: rec.studentNumber };
        }
    }
    return { ok:true };
}

// (kept) Check if the same student is switching devices (disallow)
async function checkDeviceUsage(studentNumber, deviceID) {
    const qy = query(collection(db, "student_attendance"), where("studentNumber", "==", studentNumber));
    const snapshot = await getDocs(qy);
    for (const d of snapshot.docs) {
        if (d.data().deviceID && d.data().deviceID !== deviceID) return false;
    }
    return true;
}
// ==== ALTERED END ====

// Prefill location on page load
function prefillLocation() {
    if (!navigator.geolocation) {
        console.warn("‚ö† Geolocation is not supported by your browser.");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                .then(res => res.json())
                .then(data => {
                    const addr = data.address || {};
                    const barangay = addr.neighbourhood || addr.suburb || addr.village || addr.hamlet || "Not Found";
                    const city = addr.city || addr.town || addr.municipality || "Not Found";

                    $("#barangay").val(barangay);
                    $("#city").val(city);
                })
                .catch(err => console.error("Error fetching location data:", err));
        },
        err => console.warn("Location fetch error:", err),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
}

// ==== ALTERED START: central login with modals + lock ====
async function loginUser() {
    const studentNumber = $("#studentNumber").val().trim();
    const lastName = $("#lastName").val().trim();
    const firstName = $("#firstName").val().trim();
    const course = $("#course").val();
    const selectedTime = $("#loginTime").val();
    const attendanceDate = todayISO();

    // Check active lock
    const lockUntil = getLockUntil();
    if (Date.now() < lockUntil) {
        const minutesLeft = Math.ceil((lockUntil - Date.now())/60000);
        await showMessageModal("‚õî Attendance Locked",
            `<p>Your device is temporarily locked for attendance.<br><strong>Time remaining:</strong> about ${minutesLeft} minute(s).</p>`);
        applyLockUI(lockUntil);
        return;
    }

    if (!studentNumber || !lastName || !firstName || !course || !selectedTime) {
        await showMessageModal("‚ö† Missing Information", "Please fill in all required fields.");
        return;
    }

    const allowed = await isWithinAllowedTime(selectedTime);
    if (!allowed) {
        await showMessageModal("‚è≥ Outside Time Window", "You can only log in during the allowed time slot.");
        return;
    }

    showLoading();

    try {
        const deviceID = getDeviceID();

        // One-user-per-device enforcement
        const binding = await checkDeviceBinding(studentNumber, deviceID);
        if (!binding.ok) {
            hideLoading();
            await showMessageModal("üîí Device Already In Use",
                `<p>This device is already bound to a different student number: <strong>${binding.boundTo}</strong>.</p>
                 <p>Please use your own device.</p>`);
            return;
        }

        // Prevent same student from switching devices
        if (!await checkDeviceUsage(studentNumber, deviceID)) {
            hideLoading();
            await showMessageModal("‚ö† Device Mismatch",
                "<p>Please use the same device you originally used for attendance.</p>");
            return;
        }

        // Duplicate login (same student, same slot, same day)
        if (await checkDuplicateLogin(studentNumber, selectedTime, attendanceDate)) {
            hideLoading();
            await showMessageModal("‚úÖ Already Recorded",
                "<p>You already have attendance for this time slot today.</p>");
            return;
        }

        // Get precise location
        const locationData = await new Promise((resolve, reject) => {
            if (!navigator.geolocation) return reject("‚ö† Geolocation not supported.");

            navigator.geolocation.getCurrentPosition(
                pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;

                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`)
                        .then(res => res.json())
                        .then(data => {
                            const addr = data.address || {};
                            const barangay = addr.neighbourhood || addr.suburb || addr.village || addr.hamlet || "Not Found";
                            const city = addr.city || addr.town || addr.municipality || "Not Found";

                            $("#barangay").val(barangay);
                            $("#city").val(city);

                            resolve({ latitude: lat, longitude: lon, barangay, city });
                        })
                        .catch(err => reject("‚ö† Error fetching location data: " + err));
                },
                err => reject("‚ö† Location error: " + err.message),
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        });

        // Save attendance with date and device binding fields
        await addDoc(collection(db, "student_attendance"), {
            studentNumber,
            lastName,
            firstName,
            course,
            selectedTime,
            attendanceDate, // <‚Äî NEW: record the day
            barangay: locationData.barangay,
            city: locationData.city,
            deviceID, // <‚Äî ensure device ID is stored
            latitude: locationData.latitude,
            longitude: locationData.longitude,
            timestamp: serverTimestamp()
        });

        // Success modal + 30-minute lock
        const until = setLock(LOCK_MINUTES);
        await showMessageModal("üéâ Attendance Recorded",
            `<p>Your attendance has been successfully recorded.</p>
             <p><strong>Note:</strong> Attendance is disabled on this device for the next <strong>${LOCK_MINUTES} minutes</strong>.</p>`);

        // Disable inputs and show countdown
        applyLockUI(until);

    } catch (error) {
        console.error("Error saving data:", error);
        await showMessageModal("‚ö† Error", (""+error) || "Error saving data. Please try again.");
    } finally {
        hideLoading();
    }
}
// ==== ALTERED END ====


// DOM Ready
$(document).ready(() => {
    prefillLocation();
    loadLoginTimes();
    $("#loginBtn").click(loginUser);

    // ==== ALTERED START: restore lock state on load ====
    const lockUntil = getLockUntil();
    if (Date.now() < lockUntil) {
        showMessageModal("‚õî Attendance Locked",
            "<p>Your device is currently locked due to a recent attendance submission.</p>");
        applyLockUI(lockUntil);
    }
    // ==== ALTERED END ====
});

// Instructions modal
document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("instructionModal");
    document.getElementById("closeModal").addEventListener("click", () => modal.style.display = "none");
    modal.style.display = "flex";
});
</script>

</body>
</html>

